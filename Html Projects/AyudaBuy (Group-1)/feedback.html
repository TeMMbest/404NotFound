<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AyudaBuy — Feedback</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link href="site.css" rel="stylesheet" />
  </head>
  <body class="site-body bg-light">
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <a href="AyudaBuy.html" class="text-decoration-none">
            <h2 class="mb-0">AyudaBuy Feedback</h2>
            <small class="text-muted">We don't read any of this :)</small>
          </a>
        </div>
        <div>
          <a href="AyudaBuy.html" class="btn btn-outline-secondary btn-sm me-2"
            >Back to store</a
          >
          <button id="viewToggle" class="btn btn-outline-primary btn-sm">
            Show submissions
          </button>
        </div>
      </div>

      <div class="feedback-panel">
        <div class="feedback-left">
          <div class="card p-3 site-card">
            <h5 class="mb-3">Leave feedback</h5>
            <form id="feedbackForm">
              <div class="mb-2">
                <label class="form-label">Name</label>
                <input
                  type="text"
                  name="name"
                  class="form-control"
                  placeholder="Your name"
                  required
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Email (optional)</label>
                <input
                  type="email"
                  name="email"
                  class="form-control"
                  placeholder="you@example.com"
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Contact (optional)</label>
                <input
                  type="text"
                  name="contact"
                  class="form-control"
                  placeholder="Phone No. or Social Media"
                />
              </div>
              <div class="mb-2">
                <label class="form-label">Comments</label>
                <textarea
                  name="comment"
                  class="form-control"
                  rows="5"
                  placeholder="Tell us about your experience..."
                ></textarea>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                  Submit feedback
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                  Reset
                </button>
              </div>
            </form>
            <div id="feedbackMsg" class="mt-3" aria-live="polite"></div>
          </div>
        </div>

        <div class="feedback-right">
          <div class="card p-3 site-card">
            <h5 class="mb-3">Submissions</h5>
            <div id="submissionsArea">
              <p class="text-muted">
                No submissions yet — they will appear here.
              </p>
            </div>
            <div class="mt-3 d-flex gap-2">
              <button id="clearAll" class="btn btn-sm btn-danger">
                Clear all
              </button>
              <button id="exportCsv" class="btn btn-sm btn-outline-secondary">
                Export CSV
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        var STORE_KEY = "ayudabuy_feedback";
        function load() {
          try {
            return JSON.parse(localStorage.getItem(STORE_KEY) || "[]");
          } catch (e) {
            return [];
          }
        }
        function save(items) {
          localStorage.setItem(STORE_KEY, JSON.stringify(items || []));
        }
        function renderList() {
          var area = document.getElementById("submissionsArea");
          var items = load();
          if (!items || items.length === 0) {
            area.innerHTML =
              '<p class="text-muted">No submissions yet — they will appear here.</p>';
            return;
          }
          var html = '<div class="list-group">';
          items
            .slice()
            .reverse()
            .forEach(function (it, idx) {
              var when = new Date(it.ts).toLocaleString();
              html += '<div class="list-group-item">';
              html +=
                '<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">' +
                escapeHtml(it.name || "(anonymous)") +
                "</h6><small>" +
                when +
                "</small></div>";
              if (it.email)
                html +=
                  '<div class="small text-muted">' +
                  escapeHtml(it.email) +
                  (it.contact ? " • " + escapeHtml(it.contact) : "") +
                  "</div>";
              if (it.comment)
                html +=
                  '<p class="mb-1 mt-2">' + escapeHtml(it.comment) + "</p>";
              html +=
                '<div class="text-end"><button data-idx="' +
                (items.length - 1 - idx) +
                '" class="btn btn-sm btn-link text-danger deleteItem">Delete</button></div>';
              html += "</div>";
            });
          html += "</div>";
          area.innerHTML = html;

          Array.prototype.slice
            .call(area.querySelectorAll(".deleteItem"))
            .forEach(function (b) {
              b.addEventListener("click", function () {
                var i = parseInt(b.getAttribute("data-idx"));
                var arr = load();
                arr.splice(i, 1);
                save(arr);
                renderList();
              });
            });
        }
        function escapeHtml(s) {
          return String(s || "").replace(/[&<>\"]/g, function (c) {
            return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[c];
          });
        }

        document
          .getElementById("feedbackForm")
          .addEventListener("submit", function (ev) {
            ev.preventDefault();
            var f = ev.target;
            var name = f.name.value.trim();
            if (!name) {
              document.getElementById("feedbackMsg").innerHTML =
                '<div class="text-danger">Please add your name.</div>';
              return;
            }
            var item = {
              ts: Date.now(),
              name: name,
              email: f.email.value.trim(),
              contact: f.contact.value.trim(),
              comment: f.comment.value.trim(),
            };
            var arr = load();
            arr.push(item);
            save(arr);
            f.reset();
            document.getElementById("feedbackMsg").innerHTML =
              '<div class="text-success">Thanks — your feedback has been saved.</div>';
            renderList();
          });

        document
          .getElementById("clearAll")
          .addEventListener("click", function () {
            if (
              !confirm("Clear all feedback submissions? This cannot be undone.")
            )
              return;
            save([]);
            renderList();
          });

        document
          .getElementById("exportCsv")
          .addEventListener("click", function () {
            var arr = load();
            if (!arr.length) {
              alert("No submissions to export.");
              return;
            }
            var rows = [["timestamp", "name", "email", "contact", "comment"]];
            arr.forEach(function (r) {
              rows.push([r.ts, r.name, r.email, r.contact, r.comment]);
            });
            var csv = rows
              .map(function (r) {
                return r
                  .map(function (c) {
                    return '"' + String(c || "").replace(/"/g, '""') + '"';
                  })
                  .join(",");
              })
              .join("\n");
            var blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "ayudabuy_feedback.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          });

        var shown = true;
        var viewBtn = document.getElementById("viewToggle");
        viewBtn.addEventListener("click", function () {
          shown = !shown;
          document.getElementById("submissionsArea").style.display = shown
            ? "block"
            : "none";
          viewBtn.textContent = shown ? "Hide submissions" : "Show submissions";
        });

        renderList();
      })();
    </script>
  </body>
</html>
